<!DOCTYPE html>
<html>
    <head>
        <title>Websocket Echo Test</title>
        <link href="css/bootstrap.min.css" rel="stylesheet">
        <link href="css/client.css" rel="stylesheet">
    </head>
    <body>
        <div id="login-container">
            <div class="flex-padding"></div>
            <div id="login-wrapper">
                <div class="flex-padding"></div>
                <div id="login-form">
                    <h2>Broadcast Test</h2>
                    <form>
                        <div class="form-group">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" placeholder="Enter Username">
                        </div>
                        <div class="form-group">
                            <button id="connect" type="submit" class="btn btn-primary">Connect</button>
                        </div>
                        <div class="form-group">
                            <button disabled id="call-start" class="btn btn-primary">Start Call</button>
                        </div>
                    </form>
                </div>
                <div class="flex-padding"></div>
            <div>
            </div>
            </div>
            <div class="flex-padding"></div>
        </div>
        <div class="remote-video-container">
            <video id="remote-video" autoplay muted></video>
        </div>
        <div class="local-video-container">
            <div class="flex-padding"></div>
            <div class="local-video-wrapper">
                <div class="flex-padding"></div>
                <div class="local-overflow-wrapper">
                    <video id="local-video" autoplay muted></video>
                </div>
            </div>
        </div>

    </body>
    <script type="text/javascript" src="js/jquery-3.3.1.min.js"></script>
    <script>
        var peerconnection = null;
        var isCaller = false;
        var datachannel = null;

        var username = document.getElementById("username");
        var messageInput = document.getElementById("message");
        var callButton = document.getElementById("call-start");
        var messages = document.getElementById("messages");
        var testWS = null;

        var sendMsg = function (target, msg) {
            msg["username"] = username.value;
            msg["target"] = target;
            msg["sender"] = isCaller ? "caller" : "answerer";
            console.log(msg.target);
            console.log(JSON.stringify(msg));
            testWS.send(JSON.stringify(msg));
        }

        $("#connect").click(function () {
            if (!username.value) {
                alert("ERROR: Username must not be null");
                return;
            }

            $("#connect").attr("disabled", true);
            testWS = new WebSocket("ws://localhost:5000/echo");
            testWS.onopen = function (event) {
                console.log("Hey cool, websocket open");
                sendMsg("client", {"type": "client_hello"});
                $("#call-start").attr("disabled", false);
            };

            testWS.onmessage = function (event) {
                console.log("Hey cool, a message!", event.data);
                var msg = JSON.parse(event.data);

                switch (msg.type) {
                    case "offer":
                        console.log("answering a call");
                        callButton.disabled = true;
                        $("#login-container").hide();

                        createPeerConnection();

                        var desc = new RTCSessionDescription(msg);
                        peerconnection.setRemoteDescription(desc);

                        navigator.mediaDevices.getUserMedia({audio: true, video: true})
                        .then(function(localStream) {
                            document.getElementById("local-video").srcObject = localStream;
                            localStream.getTracks().forEach(track => peerconnection.addTrack(track, localStream));
                            return peerconnection.createAnswer();
                        })
                        .then(function(answer) {
                            return peerconnection.setLocalDescription(answer);
                        })
                        .then(function() {
                            sendMsg("client", {
                                "type": peerconnection.localDescription.type,
                                "sdp": peerconnection.localDescription.sdp
                            });
                        })
                        .catch(reportError);

                        break;

                    case "answer":
                        console.log("Received an answer to my call");

                        peerconnection.setRemoteDescription(msg)
                        .catch(reportError);

                        break;

                    case "ice-candidate":
                        console.log("Got a candidate");

                        if (msg.candidate == null) {
                            console.log("Last candidate received");
                        } else {
                            var candidate = new RTCIceCandidate(msg.candidate);
                            peerconnection.addIceCandidate(candidate)
                            .catch(reportError);
                        }

                        break;

                    default:
                        console.log("Ignoring unknown message type: ", msg);
                        break;
                }
            };
        });

        callButton.onclick = function () {
            $("#login-container").hide();
            callButton.disabled = true;
            username.disabled = true;
            isCaller = true;
            createPeerConnection();
        }

        function reportError(event) {
            console.log("Error:", event);
        }

        function createPeerConnection() {
            peerconnection = new RTCPeerConnection({
                iceServers: [
                    {
                        urls: "stun:stun.l.google.com:19302"
                    }
                ]
            });

            peerconnection.onicecandidate = function (event) {
                console.log("onicecandidate", event);
                if (event.candidate == null) {
                    console.log("Last candidate received");
                } else {
                    sendMsg("client", {
                        type: "ice-candidate",
                        candidate: event.candidate
                    });
                }
            };

            peerconnection.onicecandidateerror = function (event) {
                console.log("onicecandidateerror", event);
            };

            peerconnection.onnegotiationneeded = function (event) {
                console.log("onnegotiationneeded", event);
            };

            peerconnection.oniceconnectionstatechange = function (event) {
                console.log("oniceconnectionstatechange", event);
            };

            peerconnection.onicegatheringstatechange = function (event) {
                console.log("onicegatheringstatechange", event);
            };

            peerconnection.onsignalingstatechange = function (event) {
                console.log("onsignalingstatechange", event);
            };

            peerconnection.ondatachannel = function (event) {
                console.log("Hey cool a data channel: ", event);
                datachannel = event.channel;
                datachannel.onmessage = handleDataChannelMessage;
            };

            peerconnection.ontrack = function (event) {
                console.log("Hey cool a mediastream: ", event);
                document.getElementById("remote-video").srcObject = event.streams[0];
            }

            if (isCaller) {
                navigator.mediaDevices.getUserMedia({audio: true, video: true})
                .then(function(localStream) {
                    document.getElementById("local-video").srcObject = localStream;
                    localStream.getTracks().forEach(track => peerconnection.addTrack(track, localStream));
                    
                    peerconnection.createOffer().then(function(offer) {
                        return peerconnection.setLocalDescription(offer);
                    })
                    .then(function() {
                        sendMsg("client", {
                            "type": peerconnection.localDescription.type,
                            "sdp": peerconnection.localDescription.sdp
                        });
                    })
                    .catch(reportError);
                })
                .catch(function (event) {
                    console.log("Error doing media stuff: ", event);
                });
            }
        };

    </script>
</html>
